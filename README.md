# okex合约爆仓价格计算器

计算okex的合约爆仓价格，因全仓模式的保证金率涉及到已实现盈亏(数据量比较复杂)，所以暂时先开发逐仓模式的计算。

## 参数
| 名称 | 参数 | 参数类型 | 示例 | 默认值 | 描述 | 
| ---- | ---- | ---- | ---- | ---- | ---- |
| 保证金类型 | --mgnType | `int` | `0` \ `1` | 0 | `0` PA：币本位, `1` BS：美元本位 |
| 保证金模式 | --mgnMode | `int` | `0` \ `1` | 0 | `0` cross：全仓, `1` isolated：逐仓 |
| 挂单手续费 | --makerFee | `float` | 0.02 | 0.02 | 百分比，[详情参考](https://www.okex.com/fees.html) |
| 吃单手续费 | --takerFee | `float` | 0.05 | 0.05 | 百分比，[详情参考](https://www.okex.com/fees.html) |
| 购入价格 | --buyPrice | `float` | 6666.66 | 100 | 合约成交价 |
| 购入数 | --buyCount | `float` | 222.2 | 1 | 购入量 |
| 杠杆 | --lever | `int` | 10 | 1 | 杠杆 |
| 保证金余额 | --availEq | `float` | 10.0 | 0 | 若不传参，则按最低初始保证金率计算 |
| 持仓方向 | --posSide | `string` | 'long' | 'long' | 持仓方向，`long`(做多)或者`short`(做空) |
| 最新标记价格 | --lastMarkPrice | `float` | 55000.0 | 0 | 标记价格 |

## 示例
```
python main.py --buyPrice 58000 --buyCount 10 --lever 10 --availEq 100 --posSide 'long' --lastMarkPrice 59000
```

## 计算公式

### 币本位

**逐仓保证金率：**
```
保证金率 = (固定保证金 + 未实现盈亏) / (面值 * 张数 / 最新标记价格)

未实现盈亏 (买入开多) = (面值 * 张数 / 开仓均价 - 面值 * 张数 / 最新标记价格) * 持仓量

未实现盈亏 (卖出开空) = (面值 * 张数 / 最新成交价 - 面值 * 张数 / 开仓均价) * 持仓量
```

**全仓保证金率**
```
保证金率 = (余额 + 已实现盈亏 + 未实现盈亏) / (面值 * 张数 / 最新标记价格 + 挂单冻结保证金 * 杠杆倍数)
```

**举例**
```
假设当前BTC价格为$10000，用户选择逐仓模式，10倍杠杆，开多1BTC

对应张数为100张，处于档位1，维持保证金率 = 1%，平仓手续费率 = 0.075%

保证金 = 面值 * 张数 / (BTC价格 * 杠杆倍数) = 100 * 100 / (10000 * 10) = 0.1BTC

此时，用户初始保证金率 = 1/10 = 10%

当BTC最新标记价格下跌至$9150

未实现盈亏 = 面值 * 张数 / 开仓均价 - 面值 * 张数 / 最新标记价格
          = 100 * 100 / 10000 - 100 * 100 / 9150
          = -0.0929

此时，保证金率 = (固定保证金 + 未实现盈亏) / 仓位价值
              = (0.1 - 0.0929) / (100 * 100 / 9150)
              = 0.0071 / 1.0929
              = 0.64% 
              < 维持保证金率 + 平仓手续费率 = 1.075%，此时，仓位触发爆仓
```

### USDT本位

**逐仓保证金率：**
```
保证金率 = (固定保证金 + 未实现盈亏) / (面值 * 张数 / 最新标记价格)

未实现盈亏 (买入开多) = (面值 * 张数 / 开仓均价 - 面值 * 张数 / 最新成交价) * 持仓量

未实现盈亏 (卖出开空) = (面值 * 张数 / 最新成交价 - 面值 * 张数 / 开仓均价) * 持仓量
```

**全仓保证金率**
```
保证金率 = (余额 + 已实现盈亏 + 未实现盈亏) / (面值 * 张数 / 最新标记价格 + 挂单冻结保证金 * 杠杆倍数)
```